<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="前言Android Jetpack 常用组件 Lifecycle、ViewModel、LiveData 原理分析。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Jetpack Core">
<meta property="og:url" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/index.html">
<meta property="og:site_name" content="诗与远方">
<meta property="og:description" content="前言Android Jetpack 常用组件 Lifecycle、ViewModel、LiveData 原理分析。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/final-architecture.png">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/lifecycle.svg">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/event_state.png">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/viewmodel.webp">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/viewmodel.svg">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/livedata.svg">
<meta property="og:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/livedata_good_at.png">
<meta property="article:published_time" content="2021-03-15T02:51:47.000Z">
<meta property="article:modified_time" content="2021-08-22T13:25:09.839Z">
<meta property="article:author" content="九尾灵狐">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="代码架构">
<meta property="article:tag" content="MVVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/03/15/Android-Jetpack-Core/final-architecture.png">

<link rel="canonical" href="http://yoursite.com/2021/03/15/Android-Jetpack-Core/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Android Jetpack Core | 诗与远方</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">诗与远方</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/REBOOTERS" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/15/Android-Jetpack-Core/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="九尾灵狐">
      <meta itemprop="description" content="人生不止眼前的苟且，还有诗与远方和田野">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗与远方">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android Jetpack Core
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-15 10:51:47" itemprop="dateCreated datePublished" datetime="2021-03-15T10:51:47+08:00">2021-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-22 21:25:09" itemprop="dateModified" datetime="2021-08-22T21:25:09+08:00">2021-08-22</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>27 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <img src="/2021/03/15/Android-Jetpack-Core/final-architecture.png" width="60%">

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Android Jetpack 常用组件 Lifecycle、ViewModel、LiveData 原理分析。</p>
<a id="more"></a>

<h2 id="基石-Lifecycle"><a href="#基石-Lifecycle" class="headerlink" title="基石 Lifecycle"></a>基石 Lifecycle</h2><img src="/2021/03/15/Android-Jetpack-Core/lifecycle.svg">

<p>首先可以总体看一下涉及到 Lifecycle 组件的主要类，下面就其中的细节慢慢展开。</p>
<h3 id="Lifecycle-有什么用？"><a href="#Lifecycle-有什么用？" class="headerlink" title="Lifecycle 有什么用？"></a>Lifecycle 有什么用？</h3><p>Lifecycle 是具备宿主生命周期感知能力的组件。它能持有组件（如 Activity 或 Fragment）生命周期状态的信息，并且允许其他观察者监听宿主的状态。它也是 Jetpack 组件库的的核心基础，LiveData ， ViewModel 组件等也都是基于它来实现的。</p>
<h3 id="Lifecycle-怎么用？"><a href="#Lifecycle-怎么用？" class="headerlink" title="Lifecycle 怎么用？"></a>Lifecycle 怎么用？</h3><p>其实关于 Lifecycle 怎么用本质上是在说，我们改如何实现 addObserver() 中的这个 observer .</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lifecycle.addObserver(EasyObserver())</span><br></pre></td></tr></table></figure>

<p>从上面的概览图出发，结合 LifecycleObserver 及其子类，实现一个 Lifecycle 的观察者可以有三种方式。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EasyObserver</span> : <span class="type">LifecycleObserver</span>,<span class="type">DefaultLifecycleObserver</span>, <span class="type">LifecycleEventObserver &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">foo</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(owner)</span><br><span class="line">        Log.d(LIFECYCLE_TAG, <span class="string">&quot;onCreate() called with: owner = <span class="variable">$owner</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume(owner)</span><br><span class="line">        <span class="keyword">val</span> value = owner.lifecycle.currentState</span><br><span class="line">        Log.d(LIFECYCLE_TAG, <span class="string">&quot;onResume() called onResume, currentState =<span class="variable">$value</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (value.isAtLeast(Lifecycle.State.STARTED)) &#123;</span><br><span class="line">            Log.d(LIFECYCLE_TAG, <span class="string">&quot;atLeast started&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause(owner)</span><br><span class="line">        Log.d(LIFECYCLE_TAG, <span class="string">&quot;onPause() called with: owner = <span class="variable">$owner</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStateChanged</span><span class="params">(source: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">        Log.d(LIFECYCLE_TAG, <span class="string">&quot;onStateChanged() called with: source = <span class="variable">$source</span>, event = <span class="variable">$event</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>直接实现 LifecycleObserver 接口，给自定义方法添加 OnLifecycleEvent 注解，在相应的生命周期方法触发方法调用。</li>
<li>直接实现 DefaultLifecycleObserver 接口， 覆写生命周期方法</li>
<li>直接实现 LifecycleEventObserver 接口，在其 onStateChanged 方法中按参数实现对应生命周期的功能。</li>
</ol>
<p> <strong>记得一定要在实现了 LifecycleOwner 的组件中注册这个 LifecycleObserver ,否则谁来给他分发生命周期呢？</strong></p>
<h3 id="Activity-Fragment-是如何实现-Lifecycle-的-？"><a href="#Activity-Fragment-是如何实现-Lifecycle-的-？" class="headerlink" title="Activity/Fragment 是如何实现 Lifecycle 的 ？"></a>Activity/Fragment 是如何实现 Lifecycle 的 ？</h3><p>关于如何实现 Lifecycle ，我们可以从被观察者和观察者两侧分别展开分析。</p>
<h4 id="被观察的宿主"><a href="#被观察的宿主" class="headerlink" title="被观察的宿主"></a>被观察的宿主</h4><p>首先是被观察者，也就是实现了 LifecycleOwner 接口，表示自己是可以被观察的宿主的类。在这一点上Activity 和 Fragment 本质上是相似的，都是通过借助组件自身的生命周期（Activity 早期版本依赖 ReportFragment) ，通过 LifecycleRegistry 对所有的观察者进行生命周期的分发。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line">   <span class="meta">@NonNull</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      <span class="comment">//往Activity上添加一个fragment,用以报告生命周期的变化</span></span><br><span class="line">      <span class="comment">//目的是为了兼顾不是继承自AppCompactActivity的场景.</span></span><br><span class="line">      ReportFragment.injectIfNeededIn(<span class="keyword">this</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的实现其实跟 Fragment 中的源码是一样的，在各个生命周期方法内利用 LifecycleRegistry 派发相应的 Lifecycle.Event 事件给每个观察者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        android.app.FragmentManager manager =   activity.getFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) ==   <span class="keyword">null</span>) &#123;</span><br><span class="line">            manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">            manager.executePendingTransactions();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">         Lifecycle lifecycle = activity.getLifecycle();</span><br><span class="line">         <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">             ((LifecycleRegistry)   lifecycle).handleLifecycleEvent(event);</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LifecycleRegistry 在分发事件的时候会涉及到两个概念：</p>
<ul>
<li><p><strong>宿主生命周期</strong>：就是我们烂熟于心的 <code>oncreate,onstart onresume onpause onstop</code></p>
</li>
<li><p><strong>宿主的状态</strong> ：指宿主执行了上述方法后，它处于何种生命状态了 </p>
</li>
</ul>
<img src="/2021/03/15/Android-Jetpack-Core/event_state.png">

<p>这里其实可以类比线程的生命周期状态。注意到 </p>
<ul>
<li>ON_CREATE 和 ON_STOP 这两个 event 都可以使 state 处于 CREATED; </li>
<li>ON_START 和 ON_PAUSE 这两个 event 都可以使 state 处于 STARTED</li>
</ul>
<p>这里比较微妙，可以多思考一下。我们可以看一下在 LifecycRegistry 中 <code>handleLifecycleEvent</code> 是如何处理的。</p>
<h5 id="handleLifecycleEvent"><a href="#handleLifecycleEvent" class="headerlink" title="handleLifecycleEvent"></a>handleLifecycleEvent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span></span>&#123;      </span><br><span class="line">        <span class="comment">//宿主的每个生命周期的变化都会分发一个对应的Lifecycle.Event，走到这里</span></span><br><span class="line">        <span class="comment">//此时会根据需要分发的事件反推出 宿主当前的状态</span></span><br><span class="line">        State next = getStateAfter(event);</span><br><span class="line">        moveToState(next);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// moveToState方法只是将传入的宿主新的state和前持有宿主状态作比对，然后保存一下。</span></span><br><span class="line">       <span class="comment">//如果宿主状态有变动，则调用sync方法来完成事件的分发和观察者状态的同步</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!isSynced()) &#123;</span><br><span class="line">        <span class="comment">//如果宿主当前转态 小于 mObserverMap集合中最先添加的那个观察者的状态</span></span><br><span class="line">        <span class="comment">//则说明宿主可能发生了状态回退，比如当前是RESUMED状态，执行了onPause则回退到STARTED状态</span></span><br><span class="line">        <span class="comment">//此时调用backwardPass把集合中的每个一观察者分发一个on_pause事件，并同步它的状态。</span></span><br><span class="line">            <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                backwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//如果宿主当前转态 大于 mObserverMap集合中最先添加的那个观察者的状态</span></span><br><span class="line">        <span class="comment">//则说明宿主可能发生了状态前进，比如当前是STARTED状态，执行了onResume则前进到RESUMED状态</span></span><br><span class="line">        <span class="comment">//此时调用forwardPass把集合中的每个一观察者分发一个on_resume事件，并同步它的状态。</span></span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</span><br><span class="line">            <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                forwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>说完了生命周期主动分发的场景，我们再来看看观察者注册的玄机.</p>
<h5 id="addObserver"><a href="#addObserver" class="headerlink" title="addObserver"></a>addObserver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//添加新的Observer时，会首先根据宿主的状态计算出它的初始状态，只要不是在onDestroy中注册的，它的初始状态都是INITIALIZED</span></span><br><span class="line">        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">        <span class="comment">//接着会把observer包装成ObserverWithState，这个类主要是包含了观察者及其状态。每个事件都会经由这个对象类转发,这个类后面会来分析</span></span><br><span class="line">        ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">        <span class="comment">//添加到集合，如果之前已经添加过了，则return</span></span><br><span class="line">        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line">        <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        State targetState = calculateTargetState(observer);</span><br><span class="line">        <span class="comment">//这里的while循环，是实现上图状态同步与事件分发的主要逻辑</span></span><br><span class="line">        <span class="comment">//拿观察者的状态和宿主当前状态做比较，如果小于0，说明两者状态还没有对齐。</span></span><br><span class="line">        <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">            pushParentState(statefulObserver.mState);</span><br><span class="line">            <span class="comment">//接着就会分发一次相应的事件，于此同时statefulObserver的mState对象也会被升级</span></span><br><span class="line">            <span class="comment">//假设是在宿主的onresume犯法内注册的该观察者</span></span><br><span class="line">            <span class="comment">//第一次：分发on_Create事件，观察者状态INIT-&gt;CREATED </span></span><br><span class="line">            <span class="comment">//第二次：分发on_Start事件，观察者状态CREATED-&gt;STARTED </span></span><br><span class="line">            <span class="comment">//第三次：分发on_Resume事件，观察者状态STARTED-&gt;RESUMED</span></span><br><span class="line">            statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">            <span class="comment">//再一次计算观察者应该到达的状态，在下一轮循环中和宿主状态在做比较，知道两者状态对齐，退出循环。</span></span><br><span class="line">            targetState = calculateTargetState(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Lifecycle 的特性我们在任意生命周期方法内注册观察者都能接收到完成的生命周期事件，比如在onResume 中注册一个观察者，它会依次收到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LifecycleEvent.onCreate -&gt; LifecycleEvent.onStart -&gt; LifecycleEvent.onResume</span><br></pre></td></tr></table></figure>

<p>可以看到在 addObserver 中，会根据当将当前 oberver 和其所处的状态包装成一个 ObserverWithState .我们看一下为什么要这么做。</p>
<h5 id="ObserverWithState"><a href="#ObserverWithState" class="headerlink" title="ObserverWithState"></a>ObserverWithState</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = event.getTargetState();</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个细节可以注意一下，构造函数 observer 是 LifecycleObserver 类型的，而内部的 mLifecycleObserver 是 LifecycleEventObserver 类型的，是其子类。一开始我们说了，创建 observer 时可以有多种方式。<br>而到了这里，都会统一成 LifecycleEventObserver 这种实现进行处理。</p>
<h4 id="观察者是如何实现统一的"><a href="#观察者是如何实现统一的" class="headerlink" title="观察者是如何实现统一的"></a>观察者是如何实现统一的</h4><p>至于 Lifecycling.lifecycleEventObserver 是如何将<strong>使用注解、实现 DefaultLifecycleObserver</strong> 等方式统一成 LifecycleEventObserver ，以及注解是如何生效的之类的内容，可以参考这篇<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SCNWCz9ZEIOwio9v-Tx0fA">“终于懂了“系列：Jetpack AAC完整解析，Lifecycle 完全掌握</a>，分析的很详细了。</p>
<h3 id="ProcessLifecycleOwner"><a href="#ProcessLifecycleOwner" class="headerlink" title="ProcessLifecycleOwner"></a>ProcessLifecycleOwner</h3><p>使用ProcessLifecycleOwner可以直接获取应用前后台切换状态。其实内部实现就是统计 Activity 的状态，自己实现也是可以的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册App生命周期观察者</span></span><br><span class="line">        ProcessLifecycleOwner.get().getLifecycle().addObserver(<span class="keyword">new</span> ApplicationLifecycleObserver());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Application生命周期观察，提供整个应用进程的生命周期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Lifecycle.Event.ON_CREATE只会分发一次，Lifecycle.Event.ON_DESTROY不会被分发。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 第一个Activity进入时，ProcessLifecycleOwner将分派Lifecycle.Event.ON_START, Lifecycle.Event.ON_RESUME。</span></span><br><span class="line"><span class="comment">     * 而Lifecycle.Event.ON_PAUSE, Lifecycle.Event.ON_STOP，将在最后一个Activit退出后后延迟分发。如果由于配置更改而销毁并重新创建活动，则此延迟足以保证ProcessLifecycleOwner不会发送任何事件。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 作用：监听应用程序进入前台或后台</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">        <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAppForeground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;ApplicationObserver: app moved to foreground&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_STOP)</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAppBackground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;ApplicationObserver: app moved to background&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h2><p>ViewModel 作为 Jetpack 常用的组件，最重要的原因就是其生命周期比 Activity、Fragment 长的这一点吧。</p>
<img src="/2021/03/15/Android-Jetpack-Core/viewmodel.webp" width="30%">

<p>两点优势: </p>
<ul>
<li>存储的数据只能当页面因为配置变更导致的销毁再重建时可复用</li>
<li>实现跨页面不同的（Activity）的数据共享,Application 内创建的 ViewModel ,同 Activity 多 Fragment 共享 ViewModel</li>
</ul>
<img src="/2021/03/15/Android-Jetpack-Core/viewmodel.svg" width="100%">

<p>回想我们创建 ViewModel 实例的代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> fooViewModel = ViewModelProvider(<span class="keyword">this</span>).<span class="keyword">get</span>(FooViewModel::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(<span class="meta">@NonNull</span> ViewModelStoreOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(owner.getViewModelStore(), owner <span class="keyword">instanceof</span> HasDefaultViewModelProviderFactory</span><br><span class="line">            ? ((HasDefaultViewModelProviderFactory) owner).getDefaultViewModelProviderFactory()</span><br><span class="line">            : NewInstanceFactory.getInstance());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewModelProvider</span><span class="params">(<span class="meta">@NonNull</span> ViewModelStoreOwner owner, <span class="meta">@NonNull</span> Factory factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(owner.getViewModelStore(), factory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从图示和代码可看到，ViewModelProvider 内部是靠着 ViewModelStore 和 Factory 创建和管理内部的 ViewModel 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">    ViewModel viewModel = mViewModelStore.get(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> KeyedFactory) &#123;</span><br><span class="line">        viewModel = ((KeyedFactory) mFactory).create(key, modelClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        viewModel = mFactory.create(modelClass);</span><br><span class="line">    &#125;</span><br><span class="line">    mViewModelStore.put(key, viewModel);</span><br><span class="line">    <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，我们可以确定说，要在 Activity（Fragment) 销毁的时候保证 ViewModel 的存活，其实就是要保证 ViewModelStore 的存活，而 ViewModelStore 又是由 ViewModelStoreOwner 提供的，因此。问题就来到了 ViewModelStoreOwner 是如何维护 ViewModelStore 的。</p>
<p>可以看到 Activity 和 Fragment 都以不同的方式实现了 ViewModelStoreOwner。 Activity 是直接实现接口，而 Fragment 是通过代理实现。下面就来看看其中奥秘，为什么 Activity 实例重建的时候依旧可以保持之前的 ViewModelStore 可用。</p>
<h4 id="Activity-如何维护-ViewModelStore"><a href="#Activity-如何维护-ViewModelStore" class="headerlink" title="Activity 如何维护 ViewModelStore"></a>Activity 如何维护 ViewModelStore</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">ViewModelStoreOwner</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonConfigurationInstances</span> </span>&#123;</span><br><span class="line">        Object custom;</span><br><span class="line">        ViewModelStore viewModelStore;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="comment">//从源码上可以看出，会首先从`NonConfigurationInstances`来获取`ViewModelStore`实例对象，</span></span><br><span class="line">       <span class="comment">//如果不为空那是不是就能做到复用了 ？</span></span><br><span class="line">       <span class="comment">//所以重点在于`ViewModelStore`何时被存储到`NonConfigurationInstances`里面的.</span></span><br><span class="line">           NonConfigurationInstances nc =</span><br><span class="line">                   (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">           <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mViewModelStore = nc.viewModelStore;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">               mViewModelStore = <span class="keyword">new</span> ViewModelStore();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     </span><br><span class="line">       <span class="keyword">return</span> mViewModelStore;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="onRetainNonConfigurationInstance"><a href="#onRetainNonConfigurationInstance" class="headerlink" title="onRetainNonConfigurationInstance"></a>onRetainNonConfigurationInstance</h5><blockquote>
<p>因系统原因页面被回收时，会触发该方法，所以 viewModelStore 对象此时会被存储在 NonConfigurationInstance 中。在页面恢复重建时，会再次把这个 NonConfigurationInstance 对象传递到新的Activity 中实现对象复用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">onRetainNonConfigurationInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Object custom = onRetainCustomNonConfigurationInstance();</span><br><span class="line">      ViewModelStore viewModelStore = mViewModelStore;</span><br><span class="line">      <span class="keyword">if</span> (viewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 如果NonConfigurationInstance保存了viewModelStore，把它取出来</span></span><br><span class="line">          NonConfigurationInstances nc =</span><br><span class="line">                  (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">          <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">              viewModelStore = nc.viewModelStore;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (viewModelStore == <span class="keyword">null</span> &amp;&amp; custom == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      NonConfigurationInstances nci = <span class="keyword">new</span> NonConfigurationInstances();</span><br><span class="line">      nci.custom = custom; </span><br><span class="line">	    <span class="comment">//把viewModelStore放到NonConfigurationInstances中并返回</span></span><br><span class="line">      nci.viewModelStore = viewModelStore;</span><br><span class="line">       <span class="comment">//这样当页面被销毁时ViewModelStore就被保存起来了。</span></span><br><span class="line">      <span class="keyword">return</span> nci;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的 ViewModelStore 可以被保存的条件，也就是 onRetainNonConfigurationInstance 调用的条件: <strong>due to a configuration change</strong>，手机内存不足及突然没电的场景是不符合的。<br>关于 ViewModel 保存数据更多的细节可以看看这个问题 <a target="_blank" rel="noopener" href="https://www.wanandroid.com/wenda/show/18930">每日一问 | ViewModel 在什么情况下的「销毁重建」能够对数据进行无缝恢复？</a></p>
<p>Activity onRetainNonConfigurationInstance 调用时机 ?</p>
<details>
<summary>
Called by the system, as part of destroying an 阅读更多
</summary>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called by the system, as part of destroying an</span></span><br><span class="line"><span class="comment">     * activity due to a configuration change, when it is known that a new</span></span><br><span class="line"><span class="comment">     * instance will immediately be created for the new configuration.  You</span></span><br><span class="line"><span class="comment">     * can return any object you like here, including the activity instance</span></span><br><span class="line"><span class="comment">     * itself, which can later be retrieved by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #getLastNonConfigurationInstance()&#125; in the new activity</span></span><br><span class="line"><span class="comment">     * instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;em&gt;If you are targeting &#123;<span class="doctag">@link</span> android.os.Build.VERSION_CODES#HONEYCOMB&#125;</span></span><br><span class="line"><span class="comment">     * or later, consider instead using a &#123;<span class="doctag">@link</span> Fragment&#125; with</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Fragment#setRetainInstance(boolean)</span></span><br><span class="line"><span class="comment">     * Fragment.setRetainInstance(boolean&#125;.&lt;/em&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This function is called purely as an optimization, and you must</span></span><br><span class="line"><span class="comment">     * not rely on it being called.  When it is called, a number of guarantees</span></span><br><span class="line"><span class="comment">     * will be made to help optimize configuration switching:</span></span><br><span class="line"><span class="comment">     * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt; The function will be called between &#123;<span class="doctag">@link</span> #onStop&#125; and</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #onDestroy&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;li&gt; A new instance of the activity will &lt;em&gt;always&lt;/em&gt; be immediately</span></span><br><span class="line"><span class="comment">     * created after this one&#x27;s &#123;<span class="doctag">@link</span> #onDestroy()&#125; is called.  In particular,</span></span><br><span class="line"><span class="comment">     * &lt;em&gt;no&lt;/em&gt; messages will be dispatched during this time (when the returned</span></span><br><span class="line"><span class="comment">     * object does not have an activity to be associated with).</span></span><br><span class="line"><span class="comment">     * &lt;li&gt; The object you return here will &lt;em&gt;always&lt;/em&gt; be available from</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #getLastNonConfigurationInstance()&#125; method of the following</span></span><br><span class="line"><span class="comment">     * activity instance as described there.</span></span><br><span class="line"><span class="comment">     * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;These guarantees are designed so that an activity can use this API</span></span><br><span class="line"><span class="comment">     * to propagate extensive state from the old to new activity instance, from</span></span><br><span class="line"><span class="comment">     * loaded bitmaps, to network connections, to evenly actively running</span></span><br><span class="line"><span class="comment">     * threads.  Note that you should &lt;em&gt;not&lt;/em&gt; propagate any data that</span></span><br><span class="line"><span class="comment">     * may change based on the configuration, including any data loaded from</span></span><br><span class="line"><span class="comment">     * resources such as strings, layouts, or drawables.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The guarantee of no message handling during the switch to the next</span></span><br><span class="line"><span class="comment">     * activity simplifies use with active objects.  For example if your retained</span></span><br><span class="line"><span class="comment">     * state is an &#123;<span class="doctag">@link</span> android.os.AsyncTask&#125; you are guaranteed that its</span></span><br><span class="line"><span class="comment">     * call back functions (like &#123;<span class="doctag">@link</span> android.os.AsyncTask#onPostExecute&#125;) will</span></span><br><span class="line"><span class="comment">     * not be called from the call here until you execute the next instance&#x27;s</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> #onCreate(Bundle)&#125;.  (Note however that there is of course no such</span></span><br><span class="line"><span class="comment">     * guarantee for &#123;<span class="doctag">@link</span> android.os.AsyncTask#doInBackground&#125; since that is</span></span><br><span class="line"><span class="comment">     * running in a separate thread.)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; For most cases you should use the &#123;<span class="doctag">@link</span> Fragment&#125; API</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> Fragment#setRetainInstance(boolean)&#125; instead; this is also</span></span><br><span class="line"><span class="comment">     * available on older platforms through the Android support libraries.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> any Object holding the desired state to propagate to the</span></span><br><span class="line"><span class="comment">     *         next activity instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">onRetainNonConfigurationInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details>


<h5 id="ViewModel-vs-onSaveIntanceState"><a href="#ViewModel-vs-onSaveIntanceState" class="headerlink" title="ViewModel vs onSaveIntanceState"></a>ViewModel vs onSaveIntanceState</h5><ul>
<li>onSaveIntanceState 只能存储轻量级的 key-value 键值对数据，非配置变更导致的页面被回收时才会触发，此时数据存储在 ActivityRecord 中；</li>
<li>ViewModel 可以存放任意 Object 数据，因配置变更导致的页面被回收才有效。此时存在ActivityThread#ActivityClientRecord 中。</li>
</ul>
<h5 id="SavedState"><a href="#SavedState" class="headerlink" title="SavedState"></a>SavedState</h5><blockquote>
<p>ViewModel 只能当页面因配置变更而重建时才能复用，但如果是内存不足或者电量不足等系统原因导致的页面被回收时 ViewModel 是不会被复用的</p>
</blockquote>
<p>SavedState 能够帮助开发者在 ViewModel 中处理 Activity 和 fragment 状态保存和恢复。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api <span class="string">&#x27;androidx.lifecycle:lifecycle-viewmodel-savedstate:2.2.0&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a>LiveData</h2><img src="/2021/03/15/Android-Jetpack-Core/livedata.svg" width="100%">

<h3 id="LiveData-有什么用？"><a href="#LiveData-有什么用？" class="headerlink" title="LiveData 有什么用？"></a>LiveData 有什么用？</h3><p>LiveData 组件是 Jetpack 新推出的基于观察者的消息订阅/分发组件，具有宿主（Activity、Fragment）生命周期感知能力，这种感知能力可确保 LiveData 仅分发消息给处于活跃状态(宿主处于 started，resumed 状态)的观察者，即只有处于活跃状态的观察者才能收到消息 。</p>
<img src="/2021/03/15/Android-Jetpack-Core/livedata_good_at.png" width="100%">

<h3 id="LiveData-核心原理"><a href="#LiveData-核心原理" class="headerlink" title="LiveData 核心原理"></a>LiveData 核心原理</h3><p>相比 Lifecycle 和 ViewModel，LiveData 整体的实现更加的内聚，所有逻辑基本都统一在 LiveData 内实现。</p>
<p>我们就从上面图中列出的有点出发，看看 LiveData 是如何实现<strong>数据符合页面状态、不需要手动处理生命周期、数据保持最新状态</strong> 等这些功能的。</p>
<h4 id="添加观察者"><a href="#添加观察者" class="headerlink" title="添加观察者"></a>添加观察者</h4><p>从我们日常使用 LiveData 的场景出发，看看 observe 的实现。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fooViewModel.foo.observe(viewLifecycleOwner, &#123;</span><br><span class="line">    text.text = <span class="string">&quot;result is <span class="variable">$it</span>&quot;</span></span><br><span class="line">    Log.e(TAG, <span class="string">&quot;<span class="variable">$it</span>&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>LiveData.observe</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;observe&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先会把 LifecycleOwner 和 observer 包装成一个 <code>LifecycleBoundObserver</code>。 结合上面 UML 图整体的代码架构，可以看到 LifecycleBoundObserver 本质上是一个  <code>ObserverWrapper</code> 。这里的思路和 LifecycleRegistry 的实现非常相似，就是把观察这和其所处的状态做一个封装，便于后面统一维护和更新。</p>
<figure class="highlight java"><figcaption><span>ObserverWrapper.class</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; mObserver;</span><br><span class="line">    <span class="keyword">boolean</span> mActive;</span><br><span class="line">    <span class="keyword">int</span> mLastVersion = START_VERSION;</span><br><span class="line"></span><br><span class="line">    ObserverWrapper(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        mObserver = observer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">final</span> LifecycleOwner mOwner;</span><br><span class="line"></span><br><span class="line">    LifecycleBoundObserver(<span class="meta">@NonNull</span> LifecycleOwner owner, Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">super</span>(observer);</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        Lifecycle.State currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">        <span class="keyword">if</span> (currentState == DESTROYED) &#123;</span><br><span class="line">            removeObserver(mObserver);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Lifecycle.State prevState = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (prevState != currentState) &#123;</span><br><span class="line">            prevState = currentState;</span><br><span class="line">            activeStateChanged(shouldBeActive());</span><br><span class="line">            currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>这里就比较有意思，<code>ObserverWrapper</code> 顾名思义，就是包装了一个 Observer. 同时在其内部维护了 mActive 和 mLastVersion 两个成员变量，用于记录当前 Observer 的状态。</p>
<p><code>LifecycleBoundObserver</code> (这个命名很贴切，值得学习) 在 <code>ObserverWrapper</code> 的基础上又扩展添加了 <code>LifecycleOwner</code> 。也就是说一个 LifecycleBoundObserver 的实例，做为一个观察者，即有自身的状态，又会感知组件（也就是 Activity/Fragment)的生命周期。这就有意思了。</p>
<p>可以看到在其 <code>onStateChanged</code> 方法中，观察者所在的组件的 state 处于 DESTORY 的时候，会主动移除观察者。就是这么简单，实现了不用处理生命周期，自动实现解除注册的功能。</p>
<p>而如果 currentState 不是 DESTORY 的时候，那么就会进行状态的变更。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Lifecycle.State prevState = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (prevState != currentState) &#123;</span><br><span class="line">        prevState = currentState;</span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">        currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 while 循环中，如果当前的 state 小于 STARTED .在枚举中，变量的大小是暗含在其声明顺序当中的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    DESTROYED,</span><br><span class="line">    INITIALIZED,</span><br><span class="line">    CREATED,</span><br><span class="line">    STARTED,</span><br><span class="line">    RESUMED;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，这里 isAtLeast 返回为 ture,就是说当前状态是 STARTED 或 RESUMED。否则就是 false. 在来看 <code>activeStateChanged</code></p>
<figure class="highlight java"><figcaption><span>ObserverWrapper.activeStateChanged</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// immediately set active state, so we&#x27;d never dispatch anything to inactive</span></span><br><span class="line">    <span class="comment">// owner</span></span><br><span class="line">    mActive = newActive;</span><br><span class="line">    changeActiveCounter(mActive ? <span class="number">1</span> : -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">        dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先就是对比状态的变化，也就是说只有 newActive 的值发生变化，才会继续执行，否则直接 return. 这种什么意思呢？ 就是说，如果状态从 STARTED–&gt; RESUMED 或者是 RESUMED-&gt;STARTED 。那么 <code>shouldBeActive</code> 始终是 true 。不会变更。简单来说，以 STARTED 为分界线的话，状态在 STARTED、RESUMED 之间变化 或者完全在 DESTROYED、INITIALIZED、CREATED 之间切换时，是不会 shouldBeActive 返回值是不会变化的。而只有当状态越过了这条分界线，才会变化。就会执行 <code>changeActiveCounter</code> 方法。 </li>
<li>而只有 mActive 为 TRUE 的是，也就是状态绝对的处于 STARTED/RESUMED 的时候，才会执行 dispatchingValue 进行数据的分发。<strong>这样就做到了数据始终保持最新，而且也不会在应用处于后台的时候更新数据。</strong></li>
<li>这里还有一个点，就是 LiveData 所谓的黏性事件，试想，如果我们在添加观察者之前对 LiveData 进行了 setValue/postValue 的操作，那么一旦这里 mActive 的条件成立，就会接收到之前的值，首次添加的 Observer 其 mLastVersion = START_VERSION ,一定是比变更过的当前 LiveData 小的 ，那么一定会进行触发 Observer 的更新（这里的原因，后面有解释）。</li>
</ol>
<h4 id="更新数据-setValue-postValue"><a href="#更新数据-setValue-postValue" class="headerlink" title="更新数据 setValue/postValue"></a>更新数据 setValue/postValue</h4><p>说完了添加观察者，我们再来看看数据更新，首先看 setValue。</p>
<h5 id="setValue"><a href="#setValue" class="headerlink" title="setValue"></a>setValue</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">&quot;setValue&quot;</span>);</span><br><span class="line">    mVersion++;</span><br><span class="line">    mData = value;</span><br><span class="line">    dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dispatchingValue"><a href="#dispatchingValue" class="headerlink" title="dispatchingValue"></a>dispatchingValue</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setValue 和 dispatchingValue 整体的逻辑还是比较简单的，就是做一下去重，避免重复发送。<br>注意，initiator 的类型是 ObserverWrapper 。<br>当然，这里如果是主动调用 setValue ，那么参数 initiator 为null,就需要遍历所有当前 LiveData 的观察者调用 considerNotify 。 如果是因为当前 LiveData 的状态变更，也就是注册的时候需要变化，那么对当前这一个 Observer 分发就可以了。</p>
<p>最后看 considerNotify 。</p>
<h5 id="considerNotify"><a href="#considerNotify" class="headerlink" title="considerNotify"></a>considerNotify</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check latest state b4 dispatch. Maybe it changed state but we didn&#x27;t get the event yet.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// we still first check observer.active to keep it as the entrance for events. So even if</span></span><br><span class="line">    <span class="comment">// the observer moved to an active state, if we&#x27;ve not received that event, we better not</span></span><br><span class="line">    <span class="comment">// notify for a more predictable notification order.</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">        observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>considerNotify</code> 的实现虽然看起来很简单，但是每一个行都大有玄机。</p>
<ol>
<li>observer.mActive : 添加观察者的阶段，我们就说过了，如果组件处于不可见的状态，那么他的 state 会小于 STARTED ,因此，mActive 就是 false 。 此时，调用 setValue 就会直接返回。因为，这样边保证了页面处于非活动的状态，主动通知也不会想观察者发送数据。</li>
<li>observer.shouldBeActive() 再次检测，如果代码执行到这里的时候，state 依然变化了，那么就更像 state ,同时返回。</li>
<li>数据分发</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">observer.mLastVersion = mVersion;</span><br><span class="line">observer.mObserver.onChanged((T) mData);</span><br></pre></td></tr></table></figure>
<p>这里需要整体来看，如果当前 if 条件为 FALSE。走到了下一行，那么当前这一个 Observer 的 mLastVersion 就和 mVersion 同步了。同时调用 Observer.onChanged 方法，完成数据回调。同时，在整个 LiveData 内部，可以对 mVersion 进行写操作的只有 LiveData 构造函数和 setValue 方法。因此，这里的逻辑就很清楚了，调用 setValue 对 Observer 更新值之后，如果由于其他原因再次发生 considerNotify 。那么只要 mVersion 的值没有更新，那么就不会在调用 onChanged 了，因为数据 mData 肯定没有更新，回调回去的值一定是相同的，那么对于更新 UI 来说就没有意义了，虽然在某些场景下可能有意义。</p>
<h5 id="postValue"><a href="#postValue" class="headerlink" title="postValue"></a>postValue</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> postTask;</span><br><span class="line">    <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">        postTask = mPendingData == NOT_SET;</span><br><span class="line">        mPendingData = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 setValue 和 postValue 的区别应该很简单了。这里我们可以想一下，连续多次调用 setValue 和 postValue 会有什么区别？</p>
<ol>
<li>首先对于 setValue 是在 UI 线程执行，那么他一定会保证每一次的调用。因此，观察者一定可以接收到所有的值。但是对于 postValue 来说就不一样了，首先了多线程调用的 synchronized 锁，即便过了锁这一关，<code>mPendingData</code> 在没有其他地方更新的情况下，postTaks 就是 false.因此整体逻辑直接就 return 了。那么什么时候会更新 <code>mPendingData</code> 呢？ 我们看 `mPostValueRunnable。</li>
<li>mPostValueRunnable</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable mPostValueRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object newValue;</span><br><span class="line">        <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">            newValue = mPendingData;</span><br><span class="line">            mPendingData = NOT_SET;</span><br><span class="line">        &#125;</span><br><span class="line">        setValue((T) newValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>真相只有一个，可以看到只有这个 mPostValueRunnable 被执行了，才会将 <code>mPendingData</code> 初始化。同时可以看到这里的 run 方法里使用了和 postValue 里相同对象锁。也就是说，要么对进行赋值，要么执行。这也是必须的，否则 newValue 的值就可能不是最新的了，就会发生数据丢失的问题。最后，还是调用 setValue 执行具体的数据更新。<br>但是，从这一点，可以看到连续的调用 postValue 。Observer 获取的值并不会是连续的。</p>
<p>我们可以简单试下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooViewModel</span></span>(application: Application) : AndroidViewModel(application) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> mainValue = MutableLiveData(<span class="number">0L</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> threadValue = MutableLiveData(<span class="number">0L</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doUpdate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Observable.intervalRange(<span class="number">1</span>,<span class="number">100</span>,<span class="number">1</span>,<span class="number">1</span>,TimeUnit.MILLISECONDS)</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .doOnNext &#123;</span><br><span class="line">                mainValue.value = it</span><br><span class="line">            &#125;</span><br><span class="line">            .subscribe()</span><br><span class="line"></span><br><span class="line">        Observable.intervalRange(<span class="number">1</span>,<span class="number">100</span>,<span class="number">1</span>,<span class="number">1</span>,TimeUnit.MILLISECONDS)</span><br><span class="line">            .doOnNext &#123;</span><br><span class="line">                threadValue.postValue(it)</span><br><span class="line">            &#125;</span><br><span class="line">            .subscribe()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">testSetAndPost</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fooViewModel.mainValue.observe(viewLifecycleOwner, &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;testSetAndPost&quot;</span>, <span class="string">&quot;mainValue =<span class="variable">$it</span>&quot;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        fooViewModel.threadValue.observe(viewLifecycleOwner, &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;testSetAndPost&quot;</span>, <span class="string">&quot;threadValue =<span class="variable">$it</span>&quot;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        fooViewModel.doUpdate()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里暂时忽略 RxJava 的相关问题，只是为了方便演示。我们分别在 主线程和子线程更新 <code>mainValue</code> 和 <code>threadValue</code>. 然后在任何实现了 viewLifecycleOwner 的组件内观察他们的值。多次执行，可以发现输出结果和我们上面的结论是一致的。</p>
<details>
<summary>
某一种输出
</summary>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">E/testSetAndPost: mainValue =0</span><br><span class="line">E/testSetAndPost: threadValue =0</span><br><span class="line">E/testSetAndPost: mainValue =1</span><br><span class="line">E/testSetAndPost: mainValue =2</span><br><span class="line">E/testSetAndPost: mainValue =3</span><br><span class="line">E/testSetAndPost: mainValue =4</span><br><span class="line">E/testSetAndPost: mainValue =5</span><br><span class="line">E/testSetAndPost: mainValue =6</span><br><span class="line">E/testSetAndPost: mainValue =7</span><br><span class="line">E/testSetAndPost: mainValue =8</span><br><span class="line">E/testSetAndPost: mainValue =9</span><br><span class="line">E/testSetAndPost: mainValue =10</span><br><span class="line">E/testSetAndPost: mainValue =11</span><br><span class="line">E/testSetAndPost: mainValue =12</span><br><span class="line">E/testSetAndPost: mainValue =13</span><br><span class="line">E/testSetAndPost: mainValue =14</span><br><span class="line">E/testSetAndPost: mainValue =15</span><br><span class="line">E/testSetAndPost: mainValue =16</span><br><span class="line">E/testSetAndPost: mainValue =17</span><br><span class="line">E/testSetAndPost: mainValue =18</span><br><span class="line">E/testSetAndPost: mainValue =19</span><br><span class="line">E/testSetAndPost: mainValue =20</span><br><span class="line">E/testSetAndPost: mainValue =21</span><br><span class="line">E/testSetAndPost: mainValue =22</span><br><span class="line">E/testSetAndPost: mainValue =23</span><br><span class="line">E/testSetAndPost: mainValue =24</span><br><span class="line">E/testSetAndPost: mainValue =25</span><br><span class="line">E/testSetAndPost: mainValue =26</span><br><span class="line">E/testSetAndPost: mainValue =27</span><br><span class="line">E/testSetAndPost: mainValue =28</span><br><span class="line">E/testSetAndPost: mainValue =29</span><br><span class="line">E/testSetAndPost: mainValue =30</span><br><span class="line">E/testSetAndPost: mainValue =31</span><br><span class="line">E/testSetAndPost: mainValue =32</span><br><span class="line">E/testSetAndPost: mainValue =33</span><br><span class="line">E/testSetAndPost: mainValue =34</span><br><span class="line">E/testSetAndPost: mainValue =35</span><br><span class="line">E/testSetAndPost: mainValue =36</span><br><span class="line">E/testSetAndPost: mainValue =37</span><br><span class="line">E/testSetAndPost: mainValue =38</span><br><span class="line">E/testSetAndPost: mainValue =39</span><br><span class="line">E/testSetAndPost: mainValue =40</span><br><span class="line">E/testSetAndPost: mainValue =41</span><br><span class="line">E/testSetAndPost: mainValue =42</span><br><span class="line">E/testSetAndPost: mainValue =43</span><br><span class="line">E/testSetAndPost: mainValue =44</span><br><span class="line">E/testSetAndPost: mainValue =45</span><br><span class="line">E/testSetAndPost: mainValue =46</span><br><span class="line">E/testSetAndPost: mainValue =47</span><br><span class="line">E/testSetAndPost: mainValue =48</span><br><span class="line">E/testSetAndPost: mainValue =49</span><br><span class="line">E/testSetAndPost: mainValue =50</span><br><span class="line">E/testSetAndPost: mainValue =51</span><br><span class="line">E/testSetAndPost: mainValue =52</span><br><span class="line">E/testSetAndPost: mainValue =53</span><br><span class="line">E/testSetAndPost: mainValue =54</span><br><span class="line">E/testSetAndPost: mainValue =55</span><br><span class="line">E/testSetAndPost: mainValue =56</span><br><span class="line">E/testSetAndPost: mainValue =57</span><br><span class="line">E/testSetAndPost: mainValue =58</span><br><span class="line">E/testSetAndPost: mainValue =59</span><br><span class="line">E/testSetAndPost: mainValue =60</span><br><span class="line">E/testSetAndPost: mainValue =61</span><br><span class="line">E/testSetAndPost: mainValue =62</span><br><span class="line">E/testSetAndPost: mainValue =63</span><br><span class="line">E/testSetAndPost: mainValue =64</span><br><span class="line">E/testSetAndPost: mainValue =65</span><br><span class="line">E/testSetAndPost: mainValue =66</span><br><span class="line">E/testSetAndPost: mainValue =67</span><br><span class="line">E/testSetAndPost: mainValue =68</span><br><span class="line">E/testSetAndPost: mainValue =69</span><br><span class="line">E/testSetAndPost: mainValue =70</span><br><span class="line">E/testSetAndPost: mainValue =71</span><br><span class="line">E/testSetAndPost: mainValue =72</span><br><span class="line">E/testSetAndPost: mainValue =73</span><br><span class="line">E/testSetAndPost: mainValue =74</span><br><span class="line">E/testSetAndPost: mainValue =75</span><br><span class="line">E/testSetAndPost: mainValue =76</span><br><span class="line">E/testSetAndPost: mainValue =77</span><br><span class="line">E/testSetAndPost: threadValue =76</span><br><span class="line">E/testSetAndPost: threadValue =77</span><br><span class="line">E/testSetAndPost: mainValue =78</span><br><span class="line">E/testSetAndPost: threadValue =78</span><br><span class="line">E/testSetAndPost: mainValue =79</span><br><span class="line">E/testSetAndPost: threadValue =79</span><br><span class="line">E/testSetAndPost: mainValue =80</span><br><span class="line">E/testSetAndPost: threadValue =80</span><br><span class="line">E/testSetAndPost: mainValue =81</span><br><span class="line">E/testSetAndPost: threadValue =81</span><br><span class="line">E/testSetAndPost: mainValue =82</span><br><span class="line">E/testSetAndPost: threadValue =82</span><br><span class="line">E/testSetAndPost: mainValue =83</span><br><span class="line">E/testSetAndPost: threadValue =83</span><br><span class="line">E/testSetAndPost: mainValue =84</span><br><span class="line">E/testSetAndPost: threadValue =84</span><br><span class="line">E/testSetAndPost: mainValue =85</span><br><span class="line">E/testSetAndPost: threadValue =85</span><br><span class="line">E/testSetAndPost: mainValue =86</span><br><span class="line">E/testSetAndPost: threadValue =86</span><br><span class="line">E/testSetAndPost: mainValue =87</span><br><span class="line">E/testSetAndPost: threadValue =87</span><br><span class="line">E/testSetAndPost: mainValue =88</span><br><span class="line">E/testSetAndPost: threadValue =88</span><br><span class="line">E/testSetAndPost: mainValue =89</span><br><span class="line">E/testSetAndPost: threadValue =89</span><br><span class="line">E/testSetAndPost: mainValue =90</span><br><span class="line">E/testSetAndPost: threadValue =90</span><br><span class="line">E/testSetAndPost: mainValue =91</span><br><span class="line">E/testSetAndPost: threadValue =91</span><br><span class="line">E/testSetAndPost: mainValue =92</span><br><span class="line">E/testSetAndPost: threadValue =92</span><br><span class="line">E/testSetAndPost: mainValue =93</span><br><span class="line">E/testSetAndPost: threadValue =93</span><br><span class="line">E/testSetAndPost: mainValue =94</span><br><span class="line">E/testSetAndPost: threadValue =94</span><br><span class="line">E/testSetAndPost: mainValue =95</span><br><span class="line">E/testSetAndPost: threadValue =95</span><br><span class="line">E/testSetAndPost: mainValue =96</span><br><span class="line">E/testSetAndPost: threadValue =96</span><br><span class="line">E/testSetAndPost: mainValue =97</span><br><span class="line">E/testSetAndPost: threadValue =97</span><br><span class="line">E/testSetAndPost: mainValue =98</span><br><span class="line">E/testSetAndPost: threadValue =98</span><br><span class="line">E/testSetAndPost: mainValue =99</span><br><span class="line">E/testSetAndPost: threadValue =99</span><br><span class="line">E/testSetAndPost: mainValue =100</span><br><span class="line">E/testSetAndPost: threadValue =100</span><br></pre></td></tr></table></figure>
</details>

<h3 id="LiveData-扩展"><a href="#LiveData-扩展" class="headerlink" title="LiveData 扩展"></a>LiveData 扩展</h3><p>这里就 LiveData 自身的特点做一些延伸和拓展。</p>
<h4 id="取消黏性事件"><a href="#取消黏性事件" class="headerlink" title="取消黏性事件"></a>取消黏性事件</h4><p>我们知道 LiveData 是支持黏性事件的。但凡事有利有弊，这样的特性在某些条件下是feature，但在另外一些场景下就变成了问题。下面我们看看如何实现一个更加灵活的 LiveData。</p>
<p>至于黏性事件的原因上面已经分析过了，简单来说，就是新注册的 Observer 其内部的 mLastVersion 小于 LiveData 自身的 mVersion 。如果我们在注册的时候，可以把两者对其，那不就 OK 了吗？具体怎么做呢？首先 <code>ObserverWrapper</code> 内的 mLastVersion 是保内私有的。同时也没有提供在初始化时进行赋值的接口，因此我们是无法直接进行访问的。简单粗暴一些，可以通过反射的方式强行修改这个字段。但是，这样不够优雅，其实我们可以通过代理模式解决这个问题。 version 无法对齐，那我们就手动对齐。</p>
<p>这里我们分别自定义 Observer 和 LiveData ,其中在 <code>PureLiveData</code> 中我们自己维护一个 mVersion ，自定义方法代理 setValue/postValue。同时自定义 Observer，在 <code>PureObserver</code> 中通过自定义的 <code>PureLiveData</code> 中的版本和 stick 字段，决定是否在注册观察者的阶段进行值的分发。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PureObserver</span>&lt;<span class="type">T</span>&gt;</span>(</span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">data</span>: PureLiveData&lt;T&gt;,</span><br><span class="line">    <span class="keyword">val</span> stick: <span class="built_in">Boolean</span> = <span class="literal">false</span>,</span><br><span class="line">    <span class="keyword">val</span> observer: Observer&lt;<span class="keyword">in</span> T&gt;</span><br><span class="line">) : Observer&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  1. 这个值一定是在这里取，这里是这个类创建的时候，也就是添加观察者的时候</span></span><br><span class="line"><span class="comment">     *  2. mVersion 是PureLiveData 内部自己维护的 version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> version = <span class="keyword">data</span>.mVersion</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onChanged</span><span class="params">(t: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (version &gt;= <span class="keyword">data</span>.mVersion) &#123;</span><br><span class="line">            <span class="comment">// 理论上 version == data.mVersion 就是在注册的时候</span></span><br><span class="line">            <span class="keyword">if</span> (stick &amp;&amp; <span class="keyword">data</span>.mPureData != <span class="literal">null</span>) &#123;</span><br><span class="line">                observer.onChanged(<span class="keyword">data</span>.mPureData)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果不支持 stick,那就直接返回吧</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        version = <span class="keyword">data</span>.mVersion</span><br><span class="line">        observer.onChanged(<span class="keyword">data</span>.mPureData)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PureLiveData</span>&lt;<span class="type">T</span>&gt; : <span class="type">LiveData</span>&lt;<span class="type">T</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> mPureData: T? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> mVersion = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setData</span><span class="params">(t: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.mPureData = t</span><br><span class="line">        <span class="keyword">super</span>.setValue(t)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">postData</span><span class="params">(t: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.mPureData = t</span><br><span class="line">        <span class="keyword">super</span>.postValue(t)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">        mVersion++</span><br><span class="line">        <span class="keyword">super</span>.setValue(value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">postValue</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">        mVersion++</span><br><span class="line">        <span class="keyword">super</span>.postValue(value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">observe</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, observer: <span class="type">Observer</span>&lt;<span class="type">in</span> <span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">        observePure(owner, observer, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">observePure</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, observer: <span class="type">Observer</span>&lt;<span class="type">in</span> <span class="type">T</span>&gt;, stick: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.observe(owner, PureObserver(<span class="keyword">this</span>, stick, observer))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>好了，Jetpack 最常用的几个组件暂时就分析这么多。可以看到 Lifecycle/ViewModel/LiveData 的源码实现是非常巧妙的，尤其是 LiveData，有很多值得学习和借鉴的点。很多实现非常的巧妙，值得我们实践到日常的开发中。</p>
<p>当然了，关于这个三个组件，每过一段时间阅读其源码都会有不一样的收获，都会有一些新的思考。本次阅读理解接到这里，权当是现阶段的理解，后面如果有新的体会，有更高层次的理解，再次补充。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/jetpack/guide">Google Android 官方 Jetpack 应用架构指南</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SCNWCz9ZEIOwio9v-Tx0fA">“终于懂了“系列：Jetpack AAC完整解析，Lifecycle 完全掌握</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.wanandroid.com/wenda/show/18930">每日一问 | ViewModel 在什么情况下的「销毁重建」能够对数据进行无缝恢复？</a></p>
</li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.imooc.com/read/81/article/2144">慕课网 Jetpack </a></li>
</ul>

    </div>

    
    
    
        <div class="reward-container">
  <div>加个鸡腿呗.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="九尾灵狐 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="九尾灵狐 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84/" rel="tag"># 代码架构</a>
              <a href="/tags/MVVM/" rel="tag"># MVVM</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/14/View-draw/" rel="prev" title="View draw">
      <i class="fa fa-chevron-left"></i> View draw
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/16/InspectUI-Code-Review/" rel="next" title="InspectUI Code Review">
      InspectUI Code Review <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%9F%B3-Lifecycle"><span class="nav-number">2.</span> <span class="nav-text">基石 Lifecycle</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Lifecycle-%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="nav-number">2.1.</span> <span class="nav-text">Lifecycle 有什么用？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lifecycle-%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="nav-number">2.2.</span> <span class="nav-text">Lifecycle 怎么用？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-Fragment-%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-Lifecycle-%E7%9A%84-%EF%BC%9F"><span class="nav-number">2.3.</span> <span class="nav-text">Activity&#x2F;Fragment 是如何实现 Lifecycle 的 ？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A2%AB%E8%A7%82%E5%AF%9F%E7%9A%84%E5%AE%BF%E4%B8%BB"><span class="nav-number">2.3.1.</span> <span class="nav-text">被观察的宿主</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#handleLifecycleEvent"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">handleLifecycleEvent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addObserver"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">addObserver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ObserverWithState"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">ObserverWithState</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E7%9A%84"><span class="nav-number">2.3.2.</span> <span class="nav-text">观察者是如何实现统一的</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProcessLifecycleOwner"><span class="nav-number">2.4.</span> <span class="nav-text">ProcessLifecycleOwner</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewModel"><span class="nav-number">3.</span> <span class="nav-text">ViewModel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Activity-%E5%A6%82%E4%BD%95%E7%BB%B4%E6%8A%A4-ViewModelStore"><span class="nav-number">3.0.1.</span> <span class="nav-text">Activity 如何维护 ViewModelStore</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#onRetainNonConfigurationInstance"><span class="nav-number">3.0.1.1.</span> <span class="nav-text">onRetainNonConfigurationInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ViewModel-vs-onSaveIntanceState"><span class="nav-number">3.0.1.2.</span> <span class="nav-text">ViewModel vs onSaveIntanceState</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SavedState"><span class="nav-number">3.0.1.3.</span> <span class="nav-text">SavedState</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LiveData"><span class="nav-number">4.</span> <span class="nav-text">LiveData</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LiveData-%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="nav-number">4.1.</span> <span class="nav-text">LiveData 有什么用？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LiveData-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">4.2.</span> <span class="nav-text">LiveData 核心原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%A7%82%E5%AF%9F%E8%80%85"><span class="nav-number">4.2.1.</span> <span class="nav-text">添加观察者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE-setValue-postValue"><span class="nav-number">4.2.2.</span> <span class="nav-text">更新数据 setValue&#x2F;postValue</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#setValue"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">setValue</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#dispatchingValue"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">dispatchingValue</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#considerNotify"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">considerNotify</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#postValue"><span class="nav-number">4.2.2.4.</span> <span class="nav-text">postValue</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LiveData-%E6%89%A9%E5%B1%95"><span class="nav-number">4.3.</span> <span class="nav-text">LiveData 扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E9%BB%8F%E6%80%A7%E4%BA%8B%E4%BB%B6"><span class="nav-number">4.3.1.</span> <span class="nav-text">取消黏性事件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">6.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="九尾灵狐"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">九尾灵狐</p>
  <div class="site-description" itemprop="description">人生不止眼前的苟且，还有诗与远方和田野</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/REBOOTERS" title="GitHub → https://github.com/REBOOTERS" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yingkongshi11@gmail.com" title="E-Mail → mailto:yingkongshi11@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">九尾灵狐</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">614k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:18</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
